# This job builds, tests, and deploys the packages in the monorepo
# https://github.com/github/docs/blob/main/content/actions/learn-github-actions/expressions.md
name: Build, Test, Deploy Everything
on: push
jobs:
  build-and-deploy:
    environment: beta
    runs-on: ubuntu-latest
    steps:
      # Git checkout
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v3
        with:
          persist-credentials: false
      # Collect list of changed files for conditionals later
      # use ${{ steps.files.outputs.all }} for a space-separated list of modified files
      - id: files
        uses: jitterbit/get-changed-files@v1
      - name: Install
        run: yarn install
      # Run tests, all the time
      - name: Test
        run: yarn workspaces foreach run test
      - name: Build
        run: yarn workspaces foreach --topological-dev run build
      - name: Create API image
        run: docker build . -t ${{ vars.ENV_NAME }}-cc-api:${{ github.sha }}
        working-directory: ./packages/api
      - name: Push API image to ECR
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY_SECRET }}
        run: |
          aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin ${{ secrets.ECR_DOMAIN }}
          docker tag ${{ vars.ENV_NAME }}-cc-api:${{ github.sha }} ${{ secrets.ECR_DOMAIN }}/${{ vars.ENV_NAME }}-cc-api:${{ github.sha }}
          docker push ${{ secrets.ECR_DOMAIN }}/${{ vars.ENV_NAME }}-cc-api:${{ github.sha }}
      # - name: Deploy API
      #   run:
      - name: Deploy Client
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY_SECRET }}
        run: aws s3 sync . s3://${{ secrets.AWS_CLIENT_BUCKET }}/ --delete
        working-directory: ./packages/client/dist
      # # Build & deploy storybook if client has changed (main only)
      # - name: Build Storybook
      #   if: ${{ github.ref == 'refs/heads/main' && contains(steps.files.outputs.all, 'packages/client/') }}
      #   run: |
      #     yarn workspace client build-storybook
      # - name: Deploy Storybook üöÄ
      #   if: ${{ github.ref == 'refs/heads/main' && contains(steps.files.outputs.all, 'packages/client/') }}
      #   uses: JamesIves/github-pages-deploy-action@3.6.2
      #   with:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     BRANCH: gh-pages # The branch the action should deploy to.
      #     FOLDER: packages/client/built-storybook # The folder that the build-storybook script generates files.
      #     CLEAN: true # Automatically remove deleted files from the deploy branch
      #     TARGET_FOLDER: / # The folder that we serve our Storybook files from
